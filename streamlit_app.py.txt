import streamlit as st
import pandas as pd
from datetime import datetime

# --- ç¶²é æ¨™é¡Œèˆ‡è¨­å®š ---
st.set_page_config(page_title="ç¾å®¹é ç´„ç³»çµ±", layout="centered")

# --- è³‡æ–™è®€å– (æ”¹ç‚ºé›²ç«¯ç›¸å°è·¯å¾‘) ---
DATA_FILE = "appointments.csv"
COLS = ["æ—¥æœŸ", "æ™‚æ®µ", "å®¢äººå§“å", "é›»è©±", "æ–½ä½œé …ç›®", "é‡‘é¡", "ç‹€æ…‹", "å‚™è¨»"]

def load_data():
    if os.path.exists(DATA_FILE):
        return pd.read_csv(DATA_FILE, encoding="utf-8-sig")
    else:
        return pd.DataFrame(columns=COLS)

import os
df = load_data()

# --- æ‰‹æ©Ÿç‰ˆä»‹é¢å„ªåŒ– ---
st.title("ğŸŒ¸ ç¾å®¹é ç´„ç®¡ç†")

# é ç±¤åŠŸèƒ½ï¼šåˆ‡æ›ã€Œæ–°å¢é ç´„ã€èˆ‡ã€ŒæŸ¥çœ‹æ¸…å–®ã€
tab1, tab2 = st.tabs(["ğŸ†• æ–°å¢é ç´„", "ğŸ“… é ç´„æ¸…å–®"])

with tab1:
    with st.form("add_form"):
        d = st.date_input("é ç´„æ—¥æœŸ", datetime.now())
        t = st.selectbox("æ™‚æ®µ", [f"{h:02d}:{m:02d}" for h in range(9, 22) for m in (0, 30)])
        n = st.text_input("å®¢äººå§“å")
        p = st.text_input("è¯çµ¡é›»è©±")
        s = st.text_input("é …ç›®")
        price = st.number_input("é‡‘é¡", min_value=0)
        memo = st.text_area("å‚™è¨»")
        
        if st.form_submit_button("å„²å­˜é ç´„"):
            if n:
                new_row = pd.DataFrame([[str(d), t, n, p, s, price, "é ç´„ä¸­", memo]], columns=COLS)
                df = pd.concat([df, new_row], ignore_index=True)
                df.to_csv(DATA_FILE, index=False, encoding="utf-8-sig")
                st.success(f"å·²è¨˜éŒ„ {n} çš„é ç´„")
                st.rerun()
            else:
                st.error("è«‹è¼¸å…¥å§“å")

with tab2:
    st.subheader("ç›®å‰çš„é ç´„")
    search = st.text_input("ğŸ” æœå°‹å§“å/é›»è©±")
    
    if not df.empty:
        if search:
            view_df = df[df["å®¢äººå§“å"].str.contains(search) | df["é›»è©±"].str.contains(search)]
        else:
            view_df = df.sort_values(["æ—¥æœŸ", "æ™‚æ®µ"], ascending=False)
            
        for index, row in view_df.iterrows():
            # æ‰‹æ©Ÿç‰ˆå»ºè­°ç”¨ã€Œå¡ç‰‡ã€å½¢å¼é¡¯ç¤ºï¼Œæ¯”è¡¨æ ¼å¥½è®€
            with st.expander(f"{row['æ—¥æœŸ']} {row['æ™‚æ®µ']} - {row['å®¢äººå§“å']}"):
                st.write(f"ğŸ“ é›»è©±: {row['é›»è©±']}")
                st.write(f"ğŸ’… é …ç›®: {row['æ–½ä½œé …ç›®']}")
                st.write(f"ğŸ’° é‡‘é¡: ${row['é‡‘é¡']}")
                st.write(f"ğŸ“Œ å‚™è¨»: {row['å‚™è¨»']}")
                st.write(f"ğŸš© ç‹€æ…‹: {row['ç‹€æ…‹']}")
                
                # ä¿®æ”¹ç‹€æ…‹æŒ‰éˆ•
                c1, c2 = st.columns(2)
                if c1.button("âœ… å®Œæˆ", key=f"done_{index}"):
                    df.at[index, "ç‹€æ…‹"] = "å·²å®Œæˆ"
                    df.to_csv(DATA_FILE, index=False, encoding="utf-8-sig")
                    st.rerun()
                if c2.button("ğŸ—‘ï¸ åˆªé™¤", key=f"del_{index}"):
                    df = df.drop(index)
                    df.to_csv(DATA_FILE, index=False, encoding="utf-8-sig")
                    st.rerun()
    else:
        st.write("ç›®å‰æ²’æœ‰é ç´„è³‡æ–™")